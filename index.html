<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Etson Manufacturing - Sales Order</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { background: #f0f2f5; min-height: 100vh; padding: 20px 10px; }
        .card { border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .card-header { background: #1a3a5c; color: white; text-align: center; }
        .product-card { background: #f8f9fa; border-left: 4px solid #1a3a5c; }
        .btn-primary { background: #1a3a5c; border-color: #1a3a5c; }
        .btn-primary:hover { background: #0d2840; border-color: #0d2840; }
        .text-primary { color: #1a3a5c !important; }
        .table-primary { background-color: #1a3a5c !important; color: white; }
        .table-primary th { background-color: #1a3a5c !important; color: white; }
        .bg-primary { background-color: #1a3a5c !important; }
        /* Autocomplete styles */
        .autocomplete-items { position: absolute; border: 1px solid #ddd; border-top: none; z-index: 99; width: 100%; max-height: 200px; overflow-y: auto; background: white; border-radius: 0 0 6px 6px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .autocomplete-items div { padding: 12px; cursor: pointer; }
        .autocomplete-items div:hover, .autocomplete-active { background: #1a3a5c; color: white; }
        .autocomplete-wrapper { position: relative; }
        .logo { height: 50px; margin-bottom: 10px; }
        @media print {
            body { background: white !important; padding: 0 !important; }
            .card { box-shadow: none !important; }
            .action-buttons { display: none !important; }
        }
    </style>
</head>
<body>
    <div class="container" style="max-width: 960px;">
        <div class="card">
            <div class="card-header py-4" style="background: white; border-bottom: 3px solid #1a3a5c;">
                <img src="https://etsonindia.com/wp-content/uploads/2022/03/1.png" alt="Etson" class="logo">
                <div class="text-muted"><small>Sales Order Form</small></div>
            </div>
            <div class="card-body" id="formView">
                <h6 class="text-primary mb-3">üë§ Customer Information</h6>
                
                <div class="mb-3">
                    <label class="form-label">Shop/Customer Name <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="shopName" placeholder="Enter name" required>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">City</label>
                    <input type="text" class="form-control typeahead" id="city" placeholder="Type to search city">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Contact Person</label>
                    <input type="text" class="form-control" id="contactPerson" placeholder="Enter contact person name">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Contact Number <span class="text-danger">*</span></label>
                    <input type="tel" class="form-control" id="contact" placeholder="Enter 10-digit number" pattern="[0-9]{10}" maxlength="10" required>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">GST Number (Optional)</label>
                    <input type="text" class="form-control" id="gstNo" placeholder="e.g. 23AESPR8210H1ZA" maxlength="15" style="text-transform: uppercase;">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Address</label>
                    <textarea class="form-control" id="address" rows="2" placeholder="Enter address"></textarea>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Location (Optional)</label>
                    <div class="d-flex gap-2 mb-2">
                        <button type="button" class="btn btn-outline-primary flex-fill" onclick="getCurrentLocation()">üìç Current Location</button>
                        <button type="button" class="btn btn-outline-primary flex-fill" onclick="window.open('https://www.google.com/maps', '_blank')">üó∫Ô∏è Pick on Maps</button>
                    </div>
                    <input type="url" class="form-control" id="mapLink" placeholder="Or paste Google Maps link">
                </div>
                
                <hr>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="text-primary mb-0">üì¶ Order Items</h6>
                    <button class="btn btn-warning btn-sm" onclick="addProduct()">+ Add Product</button>
                </div>
                
                <div id="products"></div>
                
                <div class="alert alert-primary d-flex justify-content-between align-items-center" id="totalBox">
                    <strong>Grand Total:</strong>
                    <span class="fs-5" id="grandTotal">‚Çπ0.00</span>
                </div>
                
                <hr>
                <div class="d-grid gap-2">
                    <button class="btn btn-primary btn-lg" onclick="generateAndCopyLink()">üìã Generate & Copy Link</button>
                    <div class="d-flex gap-2">
                        <button class="btn btn-success flex-fill" onclick="nativeShare()">üì§ Share (Mobile)</button>
                        <button class="btn btn-success flex-fill" onclick="shareToWhatsAppWeb()">üí¨ WhatsApp Web</button>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-secondary flex-fill" onclick="copyToWhatsApp()">üìÑ Copy Text</button>
                        <button class="btn btn-outline-secondary flex-fill" onclick="resetPage()">üîÑ Reset</button>
                    </div>
                </div>
                
                <div class="alert alert-success mt-3 d-none" id="output">
                    <strong>‚úì Link copied!</strong>
                    <div class="small text-break mt-2" id="linkBox"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const cities = ['Indore', 'Jabalpur', 'Bhopal', 'Gwalior', 'Ujjain', 'Dewas', 'Ratlam', 'Satna', 'Rewa', 'Sagar', 'Chhindwara', 'Burhanpur', 'Khandwa', 'Morena', 'Bhind', 'Shivpuri', 'Vidisha', 'Damoh', 'Mandsaur', 'Neemuch'];
        
        function initAutocomplete(input) {
            let currentFocus = -1;
            input.parentNode.classList.add('autocomplete-wrapper');
            
            input.addEventListener('input', function() {
                closeAllLists();
                if (!this.value) return;
                
                const list = document.createElement('div');
                list.className = 'autocomplete-items';
                list.id = 'autocomplete-list';
                this.parentNode.appendChild(list);
                
                const matches = cities.filter(c => c.toLowerCase().includes(this.value.toLowerCase()));
                matches.forEach(city => {
                    const item = document.createElement('div');
                    const idx = city.toLowerCase().indexOf(this.value.toLowerCase());
                    item.innerHTML = city.substr(0, idx) + '<strong>' + city.substr(idx, this.value.length) + '</strong>' + city.substr(idx + this.value.length);
                    item.addEventListener('click', () => { input.value = city; closeAllLists(); });
                    list.appendChild(item);
                });
            });
            
            input.addEventListener('keydown', function(e) {
                let items = document.getElementById('autocomplete-list');
                if (items) items = items.getElementsByTagName('div');
                if (e.keyCode === 40) { currentFocus++; addActive(items); }
                else if (e.keyCode === 38) { currentFocus--; addActive(items); }
                else if (e.keyCode === 13) { e.preventDefault(); if (currentFocus > -1 && items) items[currentFocus].click(); }
            });
            
            function addActive(items) {
                if (!items) return;
                for (let item of items) item.classList.remove('autocomplete-active');
                if (currentFocus >= items.length) currentFocus = 0;
                if (currentFocus < 0) currentFocus = items.length - 1;
                items[currentFocus].classList.add('autocomplete-active');
            }
            
            function closeAllLists() { document.querySelectorAll('.autocomplete-items').forEach(el => el.remove()); }
            document.addEventListener('click', closeAllLists);
        }
        
        let productCount = 0;

        const productCatalog = {
            'R79-55G-60D': { name: 'Roll 79mm (55gsm, 60dia)', price: '33', gst: '18' },
            'R79-70G-60D': { name: 'Roll 79mm (70gsm, 60dia)', price: '38', gst: '18' },
            'R57-55G-41D': { name: 'Roll 57mm - 41dia (55gsm)', price: '10.5', gst: '18' },
            'R57-55G-31D': { name: 'Roll 57mm - 31dia (55gsm)', price: '6.5', gst: '18' },
            'CUSTOM': { name: 'Custom', price: '', gst: '18' }
        };

        function addProduct(name = '', qty = '', price = '', gst = '18') {
            const id = productCount++;
            const options = Object.entries(productCatalog).map(([key, prod]) => 
                `<option value="${key}" ${key === name ? 'selected' : ''}>${prod.name}</option>`
            ).join('');
            
            const div = document.createElement('div');
            div.className = 'card product-card mb-2 p-3';
            div.id = `product-${id}`;
            div.innerHTML = `
                <div class="d-flex gap-2 mb-2">
                    <select class="form-select flex-fill" data-id="${id}" onchange="updateProductPrice(${id})">
                        ${options}
                    </select>
                    <button class="btn btn-outline-danger btn-sm" onclick="removeProduct(${id})">üóëÔ∏è</button>
                </div>
                <div class="row g-2">
                    <div class="col-4">
                        <label class="form-label small">Qty</label>
                        <input type="number" class="form-control" placeholder="0" value="${qty}" data-id="${id}" data-field="qty" oninput="updateTotal()">
                    </div>
                    <div class="col-4">
                        <label class="form-label small">Price (‚Çπ)</label>
                        <input type="number" step="0.01" class="form-control" placeholder="0" value="${price}" data-id="${id}" data-field="price" oninput="updateTotal()">
                    </div>
                    <div class="col-4">
                        <label class="form-label small">GST (%)</label>
                        <input type="number" class="form-control" placeholder="18" value="${gst}" data-id="${id}" data-field="gst" oninput="updateTotal()">
                    </div>
                </div>
            `;
            document.getElementById('products').appendChild(div);
            if (!price) updateProductPrice(id);
        }

        function updateProductPrice(id) {
            const select = document.querySelector(`select[data-id="${id}"]`);
            const product = productCatalog[select.value];
            if (product) {
                document.querySelector(`input[data-id="${id}"][data-field="price"]`).value = product.price;
                document.querySelector(`input[data-id="${id}"][data-field="gst"]`).value = product.gst;
            }
        }

        function removeProduct(id) {
            document.getElementById(`product-${id}`).remove();
            updateTotal();
        }

        function updateTotal() {
            let grandTotal = 0;
            document.querySelectorAll('.product-card').forEach(p => {
                const id = p.querySelector('select').dataset.id;
                const qty = parseFloat(p.querySelector(`[data-id="${id}"][data-field="qty"]`).value) || 0;
                const price = parseFloat(p.querySelector(`[data-id="${id}"][data-field="price"]`).value) || 0;
                const gst = parseFloat(p.querySelector(`[data-id="${id}"][data-field="gst"]`).value) || 0;
                grandTotal += qty * price * (1 + gst / 100);
            });
            document.getElementById('grandTotal').textContent = '‚Çπ' + grandTotal.toFixed(2);
        }

        function getFormData() {
            const products = [];
            document.querySelectorAll('.product-card').forEach(p => {
                const id = p.querySelector('select').dataset.id;
                products.push({
                    n: p.querySelector('select').value,
                    q: p.querySelector(`[data-id="${id}"][data-field="qty"]`).value,
                    p: p.querySelector(`[data-id="${id}"][data-field="price"]`).value,
                    g: p.querySelector(`[data-id="${id}"][data-field="gst"]`).value
                });
            });
            
            return {
                s: document.getElementById('shopName').value,
                city: document.getElementById('city').value,
                cp: document.getElementById('contactPerson').value,
                c: document.getElementById('contact').value,
                g: document.getElementById('gstNo').value,
                a: document.getElementById('address').value,
                m: document.getElementById('mapLink').value,
                p: products
            };
        }

        function generateAndCopyLink() {
            const data = getFormData();
            const encoded = btoa(encodeURIComponent(JSON.stringify(data)));
            const url = window.location.origin + window.location.pathname + '?d=' + encoded;
            
            navigator.clipboard.writeText(url).then(() => {
                document.getElementById('linkBox').textContent = url;
                document.getElementById('output').classList.remove('d-none');
            });
        }

        function loadFromURL() {
            const params = new URLSearchParams(window.location.search);
            const encoded = params.get('d');
            if (!encoded) return;
            
            try {
                const data = JSON.parse(decodeURIComponent(atob(encoded)));
                document.getElementById('shopName').value = data.s || '';
                document.getElementById('city').value = data.city || '';
                document.getElementById('contactPerson').value = data.cp || '';
                document.getElementById('contact').value = data.c || '';
                document.getElementById('gstNo').value = data.g || '';
                document.getElementById('address').value = data.a || '';
                document.getElementById('mapLink').value = data.m || '';
                
                document.getElementById('products').innerHTML = '';
                productCount = 0;
                
                if (data.p && data.p.length > 0) {
                    data.p.forEach(prod => addProduct(prod.n || '', prod.q || '', prod.p || '', prod.g || '18'));
                }
            } catch (e) {
                console.error('Error loading data:', e);
            }
        }

        function copyToWhatsApp() {
            const msg = generateWhatsAppMessage();
            navigator.clipboard.writeText(msg).then(() => {
                const btn = event.target;
                btn.textContent = '‚úì Copied!';
                setTimeout(() => btn.textContent = 'üìÑ Copy Text', 2000);
            });
        }

        function generateWhatsAppMessage() {
            const data = getFormData();
            const encoded = btoa(encodeURIComponent(JSON.stringify(data)));
            const url = window.location.origin + window.location.pathname + '?d=' + encoded;
            
            let msg = `*Order Details*\n\nShop: ${data.s}${data.city ? ' (' + data.city + ')' : ''}\n${data.cp ? 'Contact Person: ' + data.cp + '\n' : ''}Contact: ${data.c}\n\n`;
            
            let grandTotal = 0;
            data.p.forEach(prod => {
                if (prod.q && prod.p) {
                    const subtotal = parseFloat(prod.q) * parseFloat(prod.p);
                    const gstAmount = subtotal * (parseFloat(prod.g) / 100);
                    const total = subtotal + gstAmount;
                    grandTotal += total;
                    msg += `${prod.n}\nQty: ${prod.q} | Price: ‚Çπ${prod.p} + ${prod.g}% GST\nTotal: ‚Çπ${total.toFixed(2)}\n\n`;
                }
            });
            
            msg += `*Grand Total: ‚Çπ${grandTotal.toFixed(2)}*\n\n`;
            if (data.g) msg += `GST No: ${data.g}\n`;
            if (data.a) msg += `Address: ${data.a}\n`;
            if (data.m) msg += `üìç Location: ${data.m}\n`;
            msg += `\nüìã View Order: ${url}`;
            
            return msg;
        }

        function getCurrentLocation() {
            if (!navigator.geolocation) return;
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    document.getElementById('mapLink').value = `https://www.google.com/maps?q=${pos.coords.latitude},${pos.coords.longitude}`;
                },
                (err) => console.error('Location error:', err)
            );
        }

        function resetPage() {
            window.location.href = window.location.pathname;
        }

        function nativeShare() {
            const data = getFormData();
            const msg = generateWhatsAppMessage();
            const encoded = btoa(encodeURIComponent(JSON.stringify(data)));
            const url = window.location.origin + window.location.pathname + '?d=' + encoded;
            
            if (navigator.share) {
                navigator.share({ title: 'Sales Order - ' + data.s, text: msg, url: url });
            } else {
                alert('Native share not supported. Use WhatsApp Web button instead.');
            }
        }

        function shareToWhatsAppWeb() {
            const msg = generateWhatsAppMessage();
            window.open('https://wa.me/?text=' + encodeURIComponent(msg), '_blank');
        }

        function printReceipt() {
            window.print();
        }

        function downloadImage() {
            const orderView = document.getElementById('orderView');
            const buttons = document.querySelector('.action-buttons');
            buttons.style.display = 'none';
            
            html2canvas(orderView, { backgroundColor: '#ffffff', scale: 2 }).then(canvas => {
                buttons.style.display = 'flex';
                const link = document.createElement('a');
                link.download = 'order-' + new Date().toISOString().slice(0,10) + '.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }

        function editOrder() {
            const params = new URLSearchParams(window.location.search);
            params.set('edit', '1');
            window.location.search = params.toString();
        }

        function showReceipt(data) {
            let grandTotal = 0;
            (data.p || []).forEach(prod => {
                if (prod.q && prod.p) {
                    const subtotal = parseFloat(prod.q) * parseFloat(prod.p);
                    const gstAmount = subtotal * (parseFloat(prod.g || 18) / 100);
                    grandTotal += subtotal + gstAmount;
                }
            });

            document.querySelector('.card-body').innerHTML = `
                <div class="order-view" id="orderView">
                    <div class="text-center mb-4 pb-3 border-bottom">
                        <div class="text-muted small">Sales Order</div>
                        <div class="badge bg-secondary mt-2">${new Date().toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' })}</div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card bg-light h-100">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">Customer Details</h6>
                                    <h5 class="card-title mb-2">${data.s || 'Customer'}${data.city ? ' <span class="badge bg-primary">' + data.city + '</span>' : ''}</h5>
                                    ${data.cp ? '<div>üë§ ' + data.cp + '</div>' : ''}
                                    ${data.c ? '<div>üìû <a href="tel:' + data.c + '">' + data.c + '</a></div>' : ''}
                                    ${data.g ? '<div class="mt-2"><small class="text-muted">GST:</small> ' + data.g + '</div>' : ''}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mt-3 mt-md-0">
                            <div class="card bg-light h-100">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">Delivery Address</h6>
                                    <div>${data.a || 'Not provided'}</div>
                                    ${data.m ? '<a href="' + data.m + '" target="_blank" class="btn btn-sm btn-outline-primary mt-2">üìç View on Map</a>' : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <h6 class="text-primary mb-3">üì¶ Order Items</h6>
                    <div class="order-items">
                        ${(data.p || []).map((prod, i) => {
                            if (prod.q && prod.p) {
                                const subtotal = parseFloat(prod.q) * parseFloat(prod.p);
                                const gstAmount = subtotal * (parseFloat(prod.g || 18) / 100);
                                const total = subtotal + gstAmount;
                                return `
                                <div class="card mb-2">
                                    <div class="card-body py-2">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <strong>${prod.n}</strong>
                                                <div class="text-muted small">Qty: ${prod.q} √ó ‚Çπ${parseFloat(prod.p).toFixed(2)} + ${prod.g}% GST</div>
                                            </div>
                                            <div class="text-end">
                                                <strong class="text-success">‚Çπ${total.toFixed(2)}</strong>
                                            </div>
                                        </div>
                                    </div>
                                </div>`;
                            }
                            return '';
                        }).join('')}
                    </div>
                    
                    <div class="alert alert-success text-center mt-3">
                        <div class="small text-muted">Grand Total (incl. GST)</div>
                        <strong class="fs-4">‚Çπ${grandTotal.toFixed(2)}</strong>
                    </div>
                </div>
                
                <div class="d-flex gap-2 flex-wrap mt-4 action-buttons">
                    <button class="btn btn-primary flex-fill" onclick="editOrder()">‚úèÔ∏è Edit</button>
                    <button class="btn btn-info flex-fill" onclick="downloadImage()">üì∑ Save Image</button>
                    <button class="btn btn-success flex-fill" onclick="printReceipt()">üñ®Ô∏è Print</button>
                    <button class="btn btn-secondary flex-fill" onclick="resetPage()">+ New</button>
                </div>
            `;
        }

        // Init
        document.addEventListener('DOMContentLoaded', function() {
            initAutocomplete(document.getElementById('city'));
            
            const params = new URLSearchParams(window.location.search);
            const encoded = params.get('d');
            const editMode = params.get('edit');
            
            if (encoded && !editMode) {
                try {
                    const data = JSON.parse(decodeURIComponent(atob(encoded)));
                    showReceipt(data);
                } catch (e) {
                    addProduct();
                }
            } else if (encoded && editMode) {
                loadFromURL();
                updateTotal();
            } else {
                addProduct();
            }
        });
    </script>
</body>
</html>
