<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Etson Manufacturing - Sales Order</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px 10px; }
        .card { border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .card-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-align: center; }
        .product-card { background: #f8f9fa; border-left: 4px solid #667eea; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; }
        .btn-primary:hover { background: linear-gradient(135deg, #5a6fd6 0%, #6a4190 100%); }
        .receipt { font-family: 'Courier New', monospace; max-width: 400px; margin: 0 auto; }
        .receipt-header { border-bottom: 2px dashed #333; }
        .receipt-footer { border-top: 2px dashed #333; }
        /* Autocomplete styles */
        .autocomplete-items { position: absolute; border: 1px solid #ddd; border-top: none; z-index: 99; width: 100%; max-height: 200px; overflow-y: auto; background: white; border-radius: 0 0 6px 6px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .autocomplete-items div { padding: 12px; cursor: pointer; }
        .autocomplete-items div:hover, .autocomplete-active { background: #667eea; color: white; }
        .autocomplete-wrapper { position: relative; }
        @media print {
            body { background: white !important; padding: 0 !important; }
            .card { box-shadow: none !important; }
            .receipt-footer { display: none !important; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="card-header py-4">
                <h4 class="mb-1">üìã ETSON MANUFACTURING</h4>
                <small>Sales Order Form</small>
            </div>
            <div class="card-body" id="formView">
                <h6 class="text-primary mb-3">üë§ Customer Information</h6>
                
                <div class="mb-3">
                    <label class="form-label">Shop/Customer Name <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="shopName" placeholder="Enter name" required>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">City</label>
                    <input type="text" class="form-control typeahead" id="city" placeholder="Type to search city">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Contact Person</label>
                    <input type="text" class="form-control" id="contactPerson" placeholder="Enter contact person name">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Contact Number <span class="text-danger">*</span></label>
                    <input type="tel" class="form-control" id="contact" placeholder="Enter 10-digit number" pattern="[0-9]{10}" maxlength="10" required>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">GST Number (Optional)</label>
                    <input type="text" class="form-control" id="gstNo" placeholder="e.g. 23AESPR8210H1ZA" maxlength="15" style="text-transform: uppercase;">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Address</label>
                    <textarea class="form-control" id="address" rows="2" placeholder="Enter address"></textarea>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Location (Optional)</label>
                    <div class="d-flex gap-2 mb-2">
                        <button type="button" class="btn btn-outline-primary flex-fill" onclick="getCurrentLocation()">üìç Current Location</button>
                        <button type="button" class="btn btn-outline-primary flex-fill" onclick="window.open('https://www.google.com/maps', '_blank')">üó∫Ô∏è Pick on Maps</button>
                    </div>
                    <input type="url" class="form-control" id="mapLink" placeholder="Or paste Google Maps link">
                </div>
                
                <hr>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="text-primary mb-0">üì¶ Order Items</h6>
                    <button class="btn btn-warning btn-sm" onclick="addProduct()">+ Add Product</button>
                </div>
                
                <div id="products"></div>
                
                <div class="alert alert-primary d-flex justify-content-between align-items-center" id="totalBox">
                    <strong>Grand Total:</strong>
                    <span class="fs-5" id="grandTotal">‚Çπ0.00</span>
                </div>
                
                <hr>
                <div class="d-grid gap-2">
                    <button class="btn btn-primary btn-lg" onclick="generateAndCopyLink()">üìã Generate & Copy Link</button>
                    <div class="d-flex gap-2">
                        <button class="btn btn-success flex-fill" onclick="shareToWhatsApp()">üí¨ Share on WhatsApp</button>
                        <button class="btn btn-secondary flex-fill" onclick="copyToWhatsApp()">üìÑ Copy Text</button>
                    </div>
                    <button class="btn btn-outline-secondary" onclick="resetPage()">üîÑ Reset Form</button>
                </div>
                
                <div class="alert alert-success mt-3 d-none" id="output">
                    <strong>‚úì Link copied!</strong>
                    <div class="small text-break mt-2" id="linkBox"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const cities = ['Indore', 'Jabalpur', 'Bhopal', 'Gwalior', 'Ujjain', 'Dewas', 'Ratlam', 'Satna', 'Rewa', 'Sagar', 'Chhindwara', 'Burhanpur', 'Khandwa', 'Morena', 'Bhind', 'Shivpuri', 'Vidisha', 'Damoh', 'Mandsaur', 'Neemuch'];
        
        function initAutocomplete(input) {
            let currentFocus = -1;
            input.parentNode.classList.add('autocomplete-wrapper');
            
            input.addEventListener('input', function() {
                closeAllLists();
                if (!this.value) return;
                
                const list = document.createElement('div');
                list.className = 'autocomplete-items';
                list.id = 'autocomplete-list';
                this.parentNode.appendChild(list);
                
                const matches = cities.filter(c => c.toLowerCase().includes(this.value.toLowerCase()));
                matches.forEach(city => {
                    const item = document.createElement('div');
                    const idx = city.toLowerCase().indexOf(this.value.toLowerCase());
                    item.innerHTML = city.substr(0, idx) + '<strong>' + city.substr(idx, this.value.length) + '</strong>' + city.substr(idx + this.value.length);
                    item.addEventListener('click', () => { input.value = city; closeAllLists(); });
                    list.appendChild(item);
                });
            });
            
            input.addEventListener('keydown', function(e) {
                let items = document.getElementById('autocomplete-list');
                if (items) items = items.getElementsByTagName('div');
                if (e.keyCode === 40) { currentFocus++; addActive(items); }
                else if (e.keyCode === 38) { currentFocus--; addActive(items); }
                else if (e.keyCode === 13) { e.preventDefault(); if (currentFocus > -1 && items) items[currentFocus].click(); }
            });
            
            function addActive(items) {
                if (!items) return;
                for (let item of items) item.classList.remove('autocomplete-active');
                if (currentFocus >= items.length) currentFocus = 0;
                if (currentFocus < 0) currentFocus = items.length - 1;
                items[currentFocus].classList.add('autocomplete-active');
            }
            
            function closeAllLists() { document.querySelectorAll('.autocomplete-items').forEach(el => el.remove()); }
            document.addEventListener('click', closeAllLists);
        }
        
        let productCount = 0;

        const productCatalog = {
            'Roll 79mm (55gsm, 60dia)': { price: '33', gst: '18' },
            'Roll 57mm - 41dia (55gsm)': { price: '10.5', gst: '18' },
            'Roll 57mm - 31dia (55gsm)': { price: '6.5', gst: '18' },
            'Custom': { price: '', gst: '18' }
        };

        function addProduct(name = '', qty = '', price = '', gst = '18') {
            const id = productCount++;
            const options = Object.keys(productCatalog).map(p => 
                `<option value="${p}" ${p === name ? 'selected' : ''}>${p}</option>`
            ).join('');
            
            const div = document.createElement('div');
            div.className = 'card product-card mb-2 p-3';
            div.id = `product-${id}`;
            div.innerHTML = `
                <div class="d-flex gap-2 mb-2">
                    <select class="form-select flex-fill" data-id="${id}" onchange="updateProductPrice(${id})">
                        ${options}
                    </select>
                    <button class="btn btn-outline-danger btn-sm" onclick="removeProduct(${id})">üóëÔ∏è</button>
                </div>
                <div class="row g-2">
                    <div class="col-4">
                        <label class="form-label small">Qty</label>
                        <input type="number" class="form-control" placeholder="0" value="${qty}" data-id="${id}" data-field="qty" oninput="updateTotal()">
                    </div>
                    <div class="col-4">
                        <label class="form-label small">Price (‚Çπ)</label>
                        <input type="number" step="0.01" class="form-control" placeholder="0" value="${price}" data-id="${id}" data-field="price" oninput="updateTotal()">
                    </div>
                    <div class="col-4">
                        <label class="form-label small">GST (%)</label>
                        <input type="number" class="form-control" placeholder="18" value="${gst}" data-id="${id}" data-field="gst" oninput="updateTotal()">
                    </div>
                </div>
            `;
            document.getElementById('products').appendChild(div);
            if (!price) updateProductPrice(id);
        }

        function updateProductPrice(id) {
            const select = document.querySelector(`select[data-id="${id}"]`);
            const product = productCatalog[select.value];
            if (product) {
                document.querySelector(`input[data-id="${id}"][data-field="price"]`).value = product.price;
                document.querySelector(`input[data-id="${id}"][data-field="gst"]`).value = product.gst;
            }
        }

        function removeProduct(id) {
            document.getElementById(`product-${id}`).remove();
            updateTotal();
        }

        function updateTotal() {
            let grandTotal = 0;
            document.querySelectorAll('.product-card').forEach(p => {
                const id = p.querySelector('select').dataset.id;
                const qty = parseFloat(p.querySelector(`[data-id="${id}"][data-field="qty"]`).value) || 0;
                const price = parseFloat(p.querySelector(`[data-id="${id}"][data-field="price"]`).value) || 0;
                const gst = parseFloat(p.querySelector(`[data-id="${id}"][data-field="gst"]`).value) || 0;
                grandTotal += qty * price * (1 + gst / 100);
            });
            document.getElementById('grandTotal').textContent = '‚Çπ' + grandTotal.toFixed(2);
        }

        function getFormData() {
            const products = [];
            document.querySelectorAll('.product-card').forEach(p => {
                const id = p.querySelector('select').dataset.id;
                products.push({
                    n: p.querySelector('select').value,
                    q: p.querySelector(`[data-id="${id}"][data-field="qty"]`).value,
                    p: p.querySelector(`[data-id="${id}"][data-field="price"]`).value,
                    g: p.querySelector(`[data-id="${id}"][data-field="gst"]`).value
                });
            });
            
            return {
                s: document.getElementById('shopName').value,
                city: document.getElementById('city').value,
                cp: document.getElementById('contactPerson').value,
                c: document.getElementById('contact').value,
                g: document.getElementById('gstNo').value,
                a: document.getElementById('address').value,
                m: document.getElementById('mapLink').value,
                p: products
            };
        }

        function generateAndCopyLink() {
            const data = getFormData();
            const encoded = btoa(encodeURIComponent(JSON.stringify(data)));
            const url = window.location.origin + window.location.pathname + '?d=' + encoded;
            
            navigator.clipboard.writeText(url).then(() => {
                document.getElementById('linkBox').textContent = url;
                document.getElementById('output').classList.remove('d-none');
            });
        }

        function loadFromURL() {
            const params = new URLSearchParams(window.location.search);
            const encoded = params.get('d');
            if (!encoded) return;
            
            try {
                const data = JSON.parse(decodeURIComponent(atob(encoded)));
                document.getElementById('shopName').value = data.s || '';
                document.getElementById('city').value = data.city || '';
                document.getElementById('contactPerson').value = data.cp || '';
                document.getElementById('contact').value = data.c || '';
                document.getElementById('gstNo').value = data.g || '';
                document.getElementById('address').value = data.a || '';
                document.getElementById('mapLink').value = data.m || '';
                
                document.getElementById('products').innerHTML = '';
                productCount = 0;
                
                if (data.p && data.p.length > 0) {
                    data.p.forEach(prod => addProduct(prod.n || '', prod.q || '', prod.p || '', prod.g || '18'));
                }
            } catch (e) {
                console.error('Error loading data:', e);
            }
        }

        function copyToWhatsApp() {
            const data = getFormData();
            const encoded = btoa(encodeURIComponent(JSON.stringify(data)));
            const url = window.location.origin + window.location.pathname + '?d=' + encoded;
            
            let msg = `*Order Details*\n\nShop: ${data.s}${data.city ? ' (' + data.city + ')' : ''}\n${data.cp ? 'Contact Person: ' + data.cp + '\n' : ''}Contact: ${data.c}\n\n`;
            
            let grandTotal = 0;
            data.p.forEach(prod => {
                if (prod.q && prod.p) {
                    const subtotal = parseFloat(prod.q) * parseFloat(prod.p);
                    const gstAmount = subtotal * (parseFloat(prod.g) / 100);
                    const total = subtotal + gstAmount;
                    grandTotal += total;
                    msg += `${prod.n}\nQty: ${prod.q} | Price: ‚Çπ${prod.p} + ${prod.g}% GST\nTotal: ‚Çπ${total.toFixed(2)}\n\n`;
                }
            });
            
            msg += `*Grand Total: ‚Çπ${grandTotal.toFixed(2)}*\n\n`;
            if (data.g) msg += `GST No: ${data.g}\n`;
            if (data.a) msg += `Address: ${data.a}\n`;
            if (data.m) msg += `üìç Location: ${data.m}\n`;
            msg += `\nüìã View/Edit Order: ${url}`;
            
            navigator.clipboard.writeText(msg).then(() => {
                const btn = event.target;
                btn.textContent = '‚úì Copied!';
                setTimeout(() => btn.textContent = 'Copy for WhatsApp', 2000);
            });
        }

        function getCurrentLocation() {
            if (!navigator.geolocation) return;
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    document.getElementById('mapLink').value = `https://www.google.com/maps?q=${pos.coords.latitude},${pos.coords.longitude}`;
                },
                (err) => console.error('Location error:', err)
            );
        }

        function resetPage() {
            window.location.href = window.location.pathname;
        }

        function shareToWhatsApp() {
            const data = getFormData();
            if (!data.s) { alert('Please enter shop name'); return; }
            
            const encoded = btoa(encodeURIComponent(JSON.stringify(data)));
            const url = window.location.origin + window.location.pathname + '?d=' + encoded;
            
            let msg = `*Order Details*\n\nShop: ${data.s}${data.city ? ' (' + data.city + ')' : ''}\n${data.cp ? 'Contact Person: ' + data.cp + '\n' : ''}Contact: ${data.c}\n\n`;
            
            let grandTotal = 0;
            data.p.forEach(prod => {
                if (prod.q && prod.p) {
                    const subtotal = parseFloat(prod.q) * parseFloat(prod.p);
                    const gstAmount = subtotal * (parseFloat(prod.g) / 100);
                    const total = subtotal + gstAmount;
                    grandTotal += total;
                    msg += `${prod.n}\nQty: ${prod.q} | Price: ‚Çπ${prod.p} + ${prod.g}% GST\nTotal: ‚Çπ${total.toFixed(2)}\n\n`;
                }
            });
            
            msg += `*Grand Total: ‚Çπ${grandTotal.toFixed(2)}*\n\n`;
            if (data.g) msg += `GST No: ${data.g}\n`;
            if (data.a) msg += `Address: ${data.a}\n`;
            if (data.m) msg += `üìç Location: ${data.m}\n`;
            msg += `\nüìã View Order: ${url}`;
            
            window.open('https://wa.me/?text=' + encodeURIComponent(msg), '_blank');
        }

        function printReceipt() {
            window.print();
        }

        function downloadImage() {
            const receipt = document.querySelector('.receipt');
            const buttons = document.querySelector('.receipt-footer');
            buttons.style.display = 'none';
            
            html2canvas(receipt, { backgroundColor: '#ffffff', scale: 2 }).then(canvas => {
                buttons.style.display = 'flex';
                const link = document.createElement('a');
                link.download = 'order-' + new Date().toISOString().slice(0,10) + '.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }

        function editOrder() {
            const params = new URLSearchParams(window.location.search);
            params.set('edit', '1');
            window.location.search = params.toString();
        }

        function showReceipt(data) {
            let itemsHtml = '';
            let grandTotal = 0;
            
            (data.p || []).forEach(prod => {
                if (prod.q && prod.p) {
                    const subtotal = parseFloat(prod.q) * parseFloat(prod.p);
                    const gstAmount = subtotal * (parseFloat(prod.g || 18) / 100);
                    const total = subtotal + gstAmount;
                    grandTotal += total;
                    itemsHtml += `<tr><td>${prod.n}</td><td class="text-center">${prod.q}</td><td class="text-end">‚Çπ${prod.p}</td><td class="text-end">‚Çπ${total.toFixed(2)}</td></tr>`;
                }
            });

            document.querySelector('.card-body').innerHTML = `
                <div class="receipt">
                    <div class="receipt-header text-center pb-3 mb-3">
                        <h5>ETSON MANUFACTURING</h5>
                        <small class="text-muted">SALES ORDER ‚Ä¢ ${new Date().toLocaleDateString('en-IN')}</small>
                    </div>
                    
                    <div class="mb-3">
                        <strong>${data.s || 'Customer'}</strong>${data.city ? ' ‚Ä¢ ' + data.city : ''}<br>
                        ${data.cp ? 'üë§ ' + data.cp + '<br>' : ''}
                        ${data.c ? 'üìû <a href="tel:' + data.c + '">' + data.c + '</a><br>' : ''}
                        ${data.a ? 'üìç ' + data.a + '<br>' : ''}
                        ${data.g ? 'GST: ' + data.g : ''}
                    </div>
                    
                    ${data.m ? `<a href="${data.m}" target="_blank" class="btn btn-primary w-100 mb-3">üìç Open in Google Maps</a>` : ''}
                    
                    <table class="table table-sm">
                        <thead><tr><th>Item</th><th>Qty</th><th>Price</th><th>Total</th></tr></thead>
                        <tbody>${itemsHtml}</tbody>
                    </table>
                    
                    <div class="alert alert-success text-center">
                        <strong>GRAND TOTAL: ‚Çπ${grandTotal.toFixed(2)}</strong>
                        <div class="small">(Inclusive of GST)</div>
                    </div>
                    
                    <div class="receipt-footer pt-3 d-flex gap-2 flex-wrap">
                        <button class="btn btn-primary flex-fill" onclick="editOrder()">‚úèÔ∏è Edit</button>
                        <button class="btn btn-info flex-fill" onclick="downloadImage()">üì∑ Save Image</button>
                        <button class="btn btn-success flex-fill" onclick="printReceipt()">üñ®Ô∏è Print</button>
                        <button class="btn btn-secondary flex-fill" onclick="resetPage()">+ New</button>
                    </div>
                </div>
            `;
        }

        // Init
        document.addEventListener('DOMContentLoaded', function() {
            initAutocomplete(document.getElementById('city'));
            
            const params = new URLSearchParams(window.location.search);
            const encoded = params.get('d');
            const editMode = params.get('edit');
            
            if (encoded && !editMode) {
                try {
                    const data = JSON.parse(decodeURIComponent(atob(encoded)));
                    showReceipt(data);
                } catch (e) {
                    addProduct();
                }
            } else if (encoded && editMode) {
                loadFromURL();
                updateTotal();
            } else {
                addProduct();
            }
        });
    </script>
</body>
</html>
